// store.ts ì˜ executeWorkflowNode í•¨ìˆ˜ë¥¼ êµì²´í•  ì½”ë“œ

  executeWorkflowNode: async (nodeId: string, toolName?: string, params?: Record<string, any>) => {
    console.log(`ğŸš€ ë…¸ë“œ ì‹¤í–‰ ì‹œì‘: ${nodeId}`)
    
    const state = get()
    const node = state.nodes.find(n => n.id === nodeId)
    
    if (!node) {
      console.error(`âŒ ë…¸ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${nodeId}`)
      return
    }

    try {
      // 1. ë…¸ë“œ ìƒíƒœë¥¼ ì‹¤í–‰ ì¤‘ìœ¼ë¡œ ë³€ê²½
      set((state) => ({
        nodes: state.nodes.map(n => 
          n.id === nodeId 
            ? { ...n, data: { ...n.data, status: 'running' } }
            : n
        )
      }))

      // 2. OpenAI API í‚¤ í™•ì¸
      const openaiApiKey = localStorage.getItem('openai_api_key')
      if (!openaiApiKey) {
        throw new Error('OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')
      }

      // 3. AIê°€ í˜„ì¬ ë…¸ë“œì— ì í•©í•œ MCP ë„êµ¬ë¥¼ ë™ì ìœ¼ë¡œ ì„ íƒ
      console.log(`ğŸ§  AI ë„êµ¬ ì„ íƒ ì¤‘: ${node.data.label}`)
      
      const toolSelectionResponse = await fetch('http://localhost:8000/api/workflow/select-tool', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          node_description: node.data.label,
          node_prompt: node.data.prompt || '',
          workflow_context: state.nodes.map(n => ({ 
            id: n.id, 
            label: n.data.label, 
            status: n.data.status 
          })),
          openai_api_key: openaiApiKey
        })
      })

      if (!toolSelectionResponse.ok) {
        throw new Error('ë„êµ¬ ì„ íƒ API í˜¸ì¶œ ì‹¤íŒ¨')
      }

      const toolSelection = await toolSelectionResponse.json()
      console.log(`âœ… ì„ íƒëœ ë„êµ¬: ${toolSelection.tool_name}`, toolSelection.parameters)

      // 4. ì„ íƒëœ ë„êµ¬ë¡œ ì‹¤ì œ MCP ì‘ì—… ì‹¤í–‰
      console.log(`âš¡ MCP ë„êµ¬ ì‹¤í–‰ ì¤‘...`)
      
      const mcpResponse = await fetch('http://localhost:8000/api/mcp/call-tool', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tool_name: toolSelection.tool_name,
          arguments: toolSelection.parameters
        })
      })

      if (!mcpResponse.ok) {
        throw new Error('MCP ë„êµ¬ ì‹¤í–‰ ì‹¤íŒ¨')
      }

      const mcpResult = await mcpResponse.json()
      console.log(`ğŸ“Š MCP ì‹¤í–‰ ê²°ê³¼:`, mcpResult)

      // 5. AIê°€ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ê³  í•´ì„
      console.log(`ğŸ” AI ê²°ê³¼ ë¶„ì„ ì¤‘...`)
      
      const analysisResponse = await fetch('http://localhost:8000/api/workflow/analyze-result', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          node_description: node.data.label,
          tool_used: toolSelection.tool_name,
          raw_result: mcpResult,
          openai_api_key: openaiApiKey
        })
      })

      if (!analysisResponse.ok) {
        throw new Error('ê²°ê³¼ ë¶„ì„ API í˜¸ì¶œ ì‹¤íŒ¨')
      }

      const analysisResult = await analysisResponse.json()
      console.log(`ğŸ“ ë¶„ì„ ì™„ë£Œ:`, analysisResult.analysis)

      // 6. ë…¸ë“œ ìƒíƒœë¥¼ ì™„ë£Œë¡œ ë³€ê²½í•˜ê³  ëª¨ë“  ê²°ê³¼ ì €ì¥
      set((state) => ({
        nodes: state.nodes.map(n => 
          n.id === nodeId 
            ? { 
                ...n, 
                data: { 
                  ...n.data, 
                  status: 'completed',
                  result: analysisResult.analysis,
                  tool_used: toolSelection.tool_name,
                  parameters_used: toolSelection.parameters,
                  raw_data: mcpResult,
                  reasoning: toolSelection.reasoning
                } 
              }
            : n
        )
      }))

      console.log(`âœ… ë…¸ë“œ ${nodeId} ì‹¤í–‰ ì™„ë£Œ!`)

    } catch (error) {
      console.error(`âŒ ë…¸ë“œ ${nodeId} ì‹¤í–‰ ì‹¤íŒ¨:`, error)
      
      // ì—ëŸ¬ ìƒíƒœë¡œ ë…¸ë“œ ì—…ë°ì´íŠ¸
      set((state) => ({
        nodes: state.nodes.map(n => 
          n.id === nodeId 
            ? { 
                ...n, 
                data: { 
                  ...n.data, 
                  status: 'error',
                  error: error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
                } 
              }
            : n
        )
      }))
    }
  },
